<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          fontFamily: {
            display: ["Gruppo", "sans-serif"],
          },
        },
      };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Gruppo&display=swap"
      rel="stylesheet"
    />
    <link
      rel="shortcut icon"
      href="https://img.icons8.com/nolan/64/flower.png"
    />
    <title>Hana Chat</title>
  </head>
  <body class="overflow-hidden">
    <div class="flex relative flex-col w-screen h-screen">
      <header class="bg-pink-100 px-5 py-2 flex items-center" }>
        <img
          width="40"
          height="40"
          src="https://img.icons8.com/nolan/96/1A6DFF/C822FF/geometric-flowers.png"
          alt="geometric-flowers"
        />
        <h1 class="text-3xl font-display font-bold">Hana Chat</h1>
      </header>
      <content class="flex flex-1 mb-10">
        <div class="lg:flex flex-col w-1/4 h-full bg-pink-50 pb-2 hidden">
          <div id="friend-list" class="flex-1">
            <div class="h-12 flex items-center justify-center">
              <p class="text-xs text-gray-600">Friend List</p>
            </div>
          </div>
          <div
            class="h-[3px] m-auto my-4 rounded-full bg-pink-100 w-[80%]"
          ></div>
          <div class="flex-[2_2_0%]">
            <div class="flex flex-col items-center justify-center h-full m-2">
              <p class="text-xs text-gray-600">Select a chat</p>
              <div
                id="chat-list"
                class="h-full w-full mx-4 my-2 rounded-md bg-white"
              ></div>
            </div>
          </div>
        </div>

        <div id="chat-pane" class="h-full w-full relative bg-pink-100 px-2">
          <div
            id="chat-header"
            class="absolute top-0 left-0 right-0 mx-2 flex items-center h-10 pl-2 bg-white border-pink-100 border-b-[1px] z-10 shadow"
          >
            <h2 class="font-display font-bold">New Chat</h2>
          </div>

          <div
            id="message-list"
            class="absolute bottom-24 top-10 left-0 right-0 px-2 mx-2 flex bg-white flex-col-reverse overflow-y-auto py-4"
          ></div>

          <div
            id="message-composer"
            class="absolute bottom-0 left-0 right-0 mx-2 flex h-24 border-t-2 border-gray-200 p-2 bg-white rounded-md"
          >
            <textarea
              id="message-input"
              wrap="hard"
              class="w-[100%] flex-1 resize-none"
              placeholder="Enter a message..."
            ></textarea>

            <div
              id="message-button-group"
              class="flex flex-col justify-between ml-5 w-10"
            >
              <button
                id="add-attachment-button"
                class="flex-1 p-1 hover:pointer"
              >
                <img
                  width="40"
                  height="40"
                  src="https://img.icons8.com/nolan/96/1A6DFF/C822FF/full-image.png"
                  alt="full-image"
                />
              </button>
              <button id="message-send-button" class="flex-1 p-1 hover:pointer">
                <img
                  width="40"
                  height="40"
                  src="https://img.icons8.com/nolan/96/sent.png"
                  alt="sent"
                />
              </button>
            </div>
          </div>
        </div>
      </content>
      <footer
        class="absolute bottom-0 w-full flex items-center justify-center h-10 bg-pink-100 px-5 py-2"
      >
        <p class="text-xs text-gray-600">
          Disclaimer: This project is only for learning about websockets.
        </p>
      </footer>
    </div>
  </body>
  <script>
    let user = prompt("Enter your name");
    let sendBtn = document.getElementById("message-send-button");
    let messageInput = document.getElementById("message-input");
    let messageList = document.getElementById("message-list");
    let userList = document.getElementById("friend-list");
    let users = [];

    let socket = new WebSocket("ws://dave.local:8080/ws");

    socket.addEventListener("open", (event) => {
      let msg = {
        type: "user_join",
        data: user,
      };
      socket.send(JSON.stringify(msg));
    });

    socket.addEventListener("message", (event) => {
      let msg = JSON.parse(event.data);

      switch (msg.type) {
        case "user_join":
          users.push(msg.data);
          if (msg.data !== user) {
            userList.innerHTML += `
              <div class="h-12 flex items-center justify-center">
                <p class="text-xs text-gray-600">${msg.data}</p>
              </div>
            `;
          }

          messageList.innerHTML =
            `<div class="flex w-[100%] justify-start">
              <div class="p-3 w-[100%] mt-4 flex justify-around">
                <p class="break-word text-gray-500">${msg.data} has joined the chat.</p>
              </div>
            </div>` + messageList.innerHTML;
          break;
        case "chat_message":
          let isOwnMessage = msg.sender === user;
          if (isOwnMessage) {
            messageList.innerHTML =
              `<div class="flex w-[100%] justify-end">
              <div class="bg-pink-300 p-3 max-w-xs rounded-tl-2xl rounded-bl-2xl rounded-tr-2xl mt-4 shadow-lg">
                <p class="break-word">${msg.data}</p>
              </div>
            </div>` + messageList.innerHTML;
          } else {
            messageList.innerHTML =
              `<div class="flex flex-col w-[100%] justify-start">
                <p class="text-gray-400 text-sm mt-4">${msg.sender}</p>
                <div class="bg-blue-300 p-3 max-w-xs rounded-tl-2xl rounded-br-2xl rounded-tr-2xl mt-1 shadow-lg">
                  <p class="break-word">${msg.data}</p>
                </div>
              </div>` + messageList.innerHTML;
          }
      }
    });

    function enterWhenInputFocusedHandler(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        sendBtn.click();
      }
    }

    messageInput.onfocus = () => {
      messageInput.addEventListener("keydown", enterWhenInputFocusedHandler);
    };

    messageInput.onblur = () => {
      messageInput.removeEventListener("keydown", enterWhenInputFocusedHandler);
    };

    if (sendBtn.getAttribute("message-input-listener") !== "true") {
      sendBtn.addEventListener("click", function () {
        sendBtn.setAttribute("message-input-listener", "true");
        message = messageInput.value;
        if (message) {
          let msg = {
            type: "chat_message",
            data: message,
            sender: user,
          };

          socket.send(JSON.stringify(msg));
          messageInput.value = "";
        }
      });
    }
  </script>
</html>
